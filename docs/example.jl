using Plasma
using Plots

TD = 0.3
Te = 0.1
D = species.D
e = species.e

D_D = Distribution(Maxwellian(TD, D.m), D)
D_e = Distribution(Maxwellian(Te, e.m), e) 
G = Geometry() 

plasma = ElectrostaticPlasma([D_D, D_e], G)

sol = Plasma.solve(plasma, dim=1, GPU=false) 

Plasma.plot(sol)

res = [-0.2807068199541902,0.19196281173456248,-0.2866126744881214,0.17646049583125187,-0.9630558829924329,0.24144146786961737,-0.29720557801921754,-0.38428233680284574,-0.22843836006349355,-0.5343013684034145,-1.3645902698902872,-0.04003429645232812,-0.11097848758033162,-0.2209860647076342,-0.05244947441363821,1.5144930747789993,-0.5908449971347904,-0.021501325214890052,0.35792820795350777,0.22143287404174927,0.16945245180760346,0.553620095776598,-0.4167703423899994,0.24408137197969476,0.16378366483195828,0.4153540883011922,0.470181289596497,0.2908737820357733,0.18329291633206313,-0.18942287451855971,-0.19005453860886165,-0.47887587997998826,-0.2027841498831431,-2.0232848406200614,1.6093392481761934,-0.26093916302570525,-0.5619658585394468,0.2832296550597134,1.117365742210612,1.633565083406526,0.06827498964680888,2.8545596859656754,0.34153631444019644,1.1527145600002204,1.5204230200344873,2.4936226483707413,1.088139950037984,1.0760215223905465,-0.4370289282440316,0.1256075719042778,1.19747056779361,-0.5341600402028108,0.1739669979162856,-0.6317575292298171,0.365416891958499,1.4883660801073568,0.06317555782016938,3.2852561392147503,-0.6310716475875805,-0.2532614146424101,2.253519374769619,-0.4432289093241853,1.3848598270853214,1.1016909105876334,0.5729551741625353,0.4169190095344182,0.5486619491230904,-0.6028871089641035,0.17742447632928446,-0.2823509293176999,-0.2169809334497286,-0.5754281646182472,-0.29466575722785726,-0.003003423899710406,-0.35795853998567145,-0.5611226359322509,-0.2767270344437347,0.13378707053425087,-0.254211267186049,-0.20080594197233312,-0.0460487074896909,-0.27220132959599425,0.21837937064167737,0.03512140091485548,1.3515118664122736,0.8109373281351338,-0.55858041071862,0.6040579807258373,-0.8458394467490155,-0.08117861692635435,0.3156149420277844,-1.592644609739024,-1.0470350463391946,0.46726313849548656,-0.17942645267494256,0.22673941777563808,-0.6926907823841233,0.3197817068417469,-0.2542580091867529,0.2797228785199166,-0.1876106572666055,-0.4877378214975597,-0.33217280235176416,-0.009970168865217741,0.3598780939585747,-1.3863086178009838,0.16325224515252917,2.6946569772962006,0.937582004438163,-0.3227124668369831,-0.07748460609978512,-1.4289587955171674,-0.20931383346366805,0.16140119388527438,-0.23710356072295224,0.11234273256794132,0.21046130733868665,0.05892150583218001,-0.7811213028339832,0.1659114692408854,-0.0034409689319059066,0.6301903331536428,0.5773885709210317,-1.1969386744267116,-0.6932948524516953,0.5051380371231542,-0.26421719521487425,-0.23623209638376186,0.369977946032592,-0.025124402217833422,0.10880715084056954,-0.01837105156552549,0.6267778725205958,0.6322561251233857,-0.34787122844330404,0.8703666603843716,0.2872089501015285,-0.12233911245368861,-0.2609622212191197,0.5832233719490344,-0.7686071054989677,-0.3661335671678411,-0.9162373843840091,0.6801668932258341,-0.6115035062439528,-0.22424293512374888,-0.30924983896960534,-0.4067602342567462,0.17559707834545846,-0.3958070906071076,-0.4372630836134304,-0.7053759698695272,0.08554435611530997,-0.08709939316428553,-0.35300037994289,-1.237097658368825,-0.0265341913688039,-0.14622490598372595,-0.3321510225353385,-0.19207961872653168,-0.19691675465433736,1.0596824524980397,-0.5450652274035236,-0.12316724677651335,-0.712890311894425,-0.5077573264934104,-0.5222407450107007,-0.2623793339284104,0.0742780318098212,-0.10951996109990259,-0.6119405838972695,1.1654765470277082,-0.056141330290372715,-0.01611631221100698,-0.9506104062809979,-0.8445924416334505,-0.1973955259734233,0.43566586464076446,-0.3121860296708934,-0.510894224034453,0.16234287630446012,-0.4324358277020925,-0.1921785590546418,-0.016900051462261895,0.1416141234703395,-1.1310236736179715,0.0710103458628603,2.5190902165798357,0.6045853198044411,-0.1389016421233388,-0.3475437331375212,-1.7007335612390504,-0.6793204007388498,-0.4662959542967394,0.354615221680695,-0.02915295119168157,0.3398251519509485,-0.05002681011210881,-0.4032417205683875,0.1579138489499245,-0.6908184999900696,0.2738962313153399,0.4558018000396288,-0.38506617780394586,-0.4928815564592897,0.46692144341377045,-0.06437687193557541,-0.33903682114160766,-1.0958420168673058,0.02639519483110259,0.3870690560877407,-0.14127280141927098,0.10367374947653303,-0.06639976992031582,0.21735755861295378,0.025842421088559463,-0.20480069373749885,-1.1789150753011632,-0.5919558985078471,1.7285230426047886,0.14658400300434773,0.1601019204970934,-0.29959780276610365,-1.1826593904166673,0.5092885523635071,0.32380885006215543,-0.026138902061843772,-0.2907733948230424,-0.10909313914214787,-0.527654549239115,-0.7718591320589098,-0.21503509029101328,0.9814182309463011,0.6072481472792429,-0.1319562865743552,-0.5797024045249408,0.07273606080708665,-0.39211557143490805,-0.6582827733531009,0.14683459543466146,0.049112352519241745,0.22712642055967,-0.2830869827681924,-0.23899069451280688,-0.40527406997973525,-0.38744865399426354,-0.27698625450881975,0.11339001461596993,0.04913503703740643,-1.0518001635673502,0.031064751974890954,1.3993382676397859,0.5492206939723935,-0.07174669333775345,-0.5587802388904121,-1.207472366414493,-0.6746234346099106,-0.027803424255029137,0.24149900843269603,-0.40396694814187406,0.24804003937978422,-0.2125970931887882,-0.014463859180212398,-0.057927423821881686,-0.08130303264419614,-0.9872856962595298,-0.5593792408601392,2.4400878896010165,0.11294400725948225,0.0028839444434122737,-0.022545970344392107,-1.4887302653302845,0.19947301314303365,1.4381280579585871,-0.48726727331737923,-0.5903593221072136,-1.4388102453227745,-0.5297049836688752,-0.33350791332877067,-1.057503734195186,0.3187381573456417,-0.5615772145776161,-0.6862402709623716,1.5756304766841533,0.6065603289032636,-1.0559699170750854,-1.1406343809547,-0.6454997312445501,-0.5375531318525366,0.4241349964443473,0.21496720041279588,0.05575260545940561,-0.6856102522645082,0.150182928263919,-0.03746172791994397,-0.34118432299676366,0.4244199042152312,-0.9493412378588014,-0.05362109895946457,1.766442138024038,-0.10073704431735969,-0.5887524886063012,-0.2094831894312868,-1.3143307937867992,-0.7929398064779607,0.7890915237544242,-0.4781372544009796,0.3634400231196709,-0.43033088603215847,-0.24014633507790545,-0.6377621638192096,-0.9638468643113829,-0.042894921868604524,-0.5110889473043547,0.17233321425457596,0.6966417321455856,0.31042297559416765,-0.2334632132748445,-0.39484439489961665,-0.5698511386008086,-0.7468728210300242,-0.4031732219493516,0.16289902097163192,0.17726394984370816,0.37931211180884766,0.3047093656501535,-0.5786437700123728,0.15771249659831807,-0.31281670345832396,-0.4021812390193912,0.6382831590586997,0.03339159415727603,-0.9174209698063893,0.4185250839252519,-0.21514084083865292,-0.8015025512630588,-0.7154482809870605,-0.1534404944644952,0.4561228142348051,-0.23843460154588805,0.6861175051455212,0.5398389615396704,-0.15094073709832762,0.5377021646695691,-0.27269518149249006,-1.4525380234830005,-0.24255148458297768,1.000906081979745,-0.5881276018796362,0.4162828070973818,0.11456296102309851,-1.725496967180448,-0.4759942148798655,-0.4028527376723118,-0.5852291799403699,-0.29790772538456,-0.11090872760049598,0.056020549017472006,-0.3115596226502703,0.2189906804351326,0.07711655233471251,-0.3716190851488891,0.1608304124509467,0.6426399983575365,0.25353465464390046,-0.5321591040392893,0.5682483244443497,-0.23007977229954224,-0.013811773859654106,0.38454029815802104,0.1885081712416498,0.16592775874964372,-0.3326993482418518,-0.194615070060899,-0.11559999998171776,-0.33395097763908477,0.49409724593102167,0.3350958064081841,-0.1120763378423032,0.2663889253530708,0.13535563467603404,0.24537916744202867,-0.4508216085950441,-0.40386040083988306,0.06409430425429426,0.004880809715887622,0.012086487070535057,0.009492760426153162,0.0065406714770887145,-0.0013051804852335864,0.005606276042623984,0.0437780444179628,0.015754412233994403,-0.00546669802160623,0.001161787243843841,0.02033815776245902,-0.004581784431900368,-0.011750712040941148,0.02051517338646796,0.015076720289154652,-0.0003355231551681425,-0.3165329130891149,-0.37561032232122876,-0.17442609743470366,-0.21319396700224302,0.05796469106336816,-0.4112117057482352,0.07389806652617877,-0.3308832971187063,-0.38563666443135136,0.04119942627037993,0.2630383400526468,0.1804470726121995,0.2462423663790919,-0.03249972436166613,0.3268138720558085,-0.07085254276514437,-0.2526590089448545,0.35169692431299243,0.08525660266940208,-0.06551817929156588,0.2094584487902555,-0.18174945531266612,-0.14193705447339594,-0.33887740247817005,0.10817951052556851,0.2824430689806982,-0.2718458535289953,-0.37819389337532583,0.12491645651885461,-0.28887943571460606,0.3615572947389381,0.11845040641724458,-0.36283451527058175,0.026385281955766313,0.17327879025310233,-0.344096819384686,-0.20525837413929376,-0.4068688727060905,0.40344601266952496,-0.29416883956282425,-0.04553113617072082,0.40586519871011967,-0.17940635754022968,-0.19992267084210746,0.0433281787884247,-0.05669204173197358,0.4026993147948094,-0.1979388072409069,0.07762500067093182,0.24475286282085,0.001384516233448805,0.31548414231985306,-0.40031326212011953,0.1695892968194095,-0.057568256017059914,0.10356783609674088,-0.27141309779019285,-0.1461160838896787,0.03212311007384791,-0.4119608924067518,0.12964889852467731,0.11563270847854004,-0.41674136117211485,0.07331870757333864,-0.02050457874666277,0.13644018877887296,0.15180656034439693,0.22754263234268843,-0.2285743358197207,-0.40013828219993547,0.12844420462815853,0.19386669868865206,-0.039201832798489294,-0.22423464476128366,-0.4114667377522561,-0.3035275023205487,-0.06262539278572897,-0.10449878508686167,0.1945419289584041,0.3090693728480124,0.18552857823957153,0.1236495277876711,-0.4252466869484619,0.26617480679486744,0.3703137674584349,-0.335398073054952,-0.41522044280656084,-0.39004313037207555,0.07369976949885514,0.34624123214623204,0.2959611166947134,-0.412638710694429,0.30651397625364596,0.04593893857955168,-0.35450850224294667,-0.07886767542461395,-0.27450270012077554,0.3268248869611277,-0.38255358669261913,-0.2427915321669811,0.147488212196063,0.287700135206563,-0.33218162091878844,0.2665354902063092,0.05976446621670903,-0.011937892155442095,0.3543193501909775,-0.3159191493197152,0.02778600223894192,0.1869708384688421,0.1790128105212845,-0.44572971932375716,-0.25870966871066337,0.22289709069916394,-0.23057809774013374,0.1828685494780654,0.11996286523595406,0.032189304879432924,-0.14321111267014394,-0.3648375784072025,0.37300250933563656,0.22163328071776695,-0.00475575048679356,0.23531104141540196,0.2111610902560179,0.18004537676064178,0.2369830321119679,-0.25622453457511996,-0.3805919964183902,-0.15184318848442638,0.15114632491919766,0.42288070376203973,0.07610927516221666,0.2764875898657685,0.3070115403536862,0.1324724354939744,0.2612622501512954,0.3508938020335562,0.26925087889053195,0.2807803164510196,0.3150155475929709,-0.3506082370223831,-0.08060294751642015,0.21744351103936302,-0.19213464470324582,0.3947430211537722,-0.41692870084396955,-0.39819562913129086,0.1119145666588098,-0.29095447699389965,0.231113812418464,-0.07435328133977609,-0.34588020589346985,0.2004091730717102,-0.3709697156328894,-0.013099243192519447,-0.1198755144039145,-0.37333371440325647,0.33791237474383823,0.07414118547162905,0.2889874667182829,-0.023846369360063735,0.05539084045962397,0.4071612798005007,-0.31881657726467233,0.009620577867454575,0.41711313935438954,0.15050091083999678,0.3292148146149932,0.1804304666472817,-0.12581953835499093,-0.3792100854934257,-0.32500098850674636,-0.2870325060147966,-0.3947035761791538,-0.22485028478280192,0.163276451401028,-0.03179133071670241,0.06357529197452745,0.39989767875751997,-0.37852245683927804,-0.44997018448057685,0.14078151978683362,0.21584699581559066,0.19238030087620717,0.13708656527635676,-0.3967356239665007,0.07040153109434405,0.382392571440269,-0.42044025479344593,-0.22591942653475938,0.12073798477616085,-0.3782670227501601,0.08051490800945584,0.11544289695321545,0.37731101355864166,0.22650415653987824,0.2108915071694051,0.37810870763448573,0.08563641953382603,-0.34685799686808605,-0.2792517289200377,-0.21434301422190222,-0.14761304170566245,0.29447256949190304,-0.04619681275017343,0.11968078293404602,0.10758751055717818,0.2737667088266196,0.0794416989956449,0.24193407370862313,0.02175185598870984,-0.09454737664314722,0.05184367080509567,-0.2798353288372427,-0.07204349755630252,-0.36030254091006136,-0.3850594214438224,-0.02359348601232687,-0.03318053229509509,0.03976632715377979,0.37686278596439077,0.1712921819117291,-0.07429035595658669,0.07425938047912857,0.23127914412206796,-0.41768284681666246,0.05239611464578199,0.09406063744756284,-0.3478247793294514,-0.1004282745969668,0.13790023898477824,0.29331618629358647,-0.08659549607295708,-0.3865068270032484,-0.11192850346908798,-0.04252267284594774,0.18559310476777424,-0.27134474175183404,-0.3133494084348058,0.15399068536172053,0.02998710403457768,-0.00698935676053966,0.009297231695766652,0.255133510759655,0.06649237610175876,-0.04912024628110623,0.0868950939481591,0.22206902515361363,-0.1236832855961266,0.1786937980349154,-0.20081612675668917,-0.08257079268211195,0.08200899886744663,-0.005376849135466559,-0.1224045265763893,-0.029884176940811982,-0.0053154171455199375,-0.01813582143573625,-0.001076633275247167,0.02045093580118685,-0.03615843955255092,-0.028294593901580373,-0.02872530090518042,-0.024335070985519534,-0.007919458107286868,-0.0007067725502696763,-0.029198096813661513,0.0033813382229222677,0.0008640352463243611,-0.013260147303652449,-0.017465201012645086,0.4547020028557079,-0.041834500470219596,0.2382800872699605,0.20094669907881285,0.3760852395939545,-0.4290775090550992,0.3343759251048117,0.19669089871816153,-0.031721776389084834,-0.3205192233229117,0.1694327558383011,0.3315747871468094,-0.4028115737542328,-0.35477233905759553,-0.2427177770119023,-0.4641448873150442,0.09239890864127062]
## Two-stream instability

e = species.e

function TwoStream(vth2, vs1, vs2) 

    function P(x,v)
        if !(v isa Array)
            v = [v]    
        end

        if !(x isa Array)
            x = [x]    
        end

        v = sqrt(sum(v .^2))
        x = sqrt(sum(x .^2))

        0.5/sqrt(vth2 * π) * exp(-(v-vs1)*(v-vs1)/vth2) + 0.5/sqrt(vth2 * π) * exp(-(v-vs2)*(v-vs2)/vth2) * (1+0.02*cos(3*π*x))
    end
end

D_e = Distribution(TwoStream(0.02, 1.6, -1.4), e) 
G = Geometry() 

plasma = ElectrostaticPlasma([D_e], G)

sol = Plasma.solve(plasma, dim=1, GPU=false, time_ub = 100.0, ub=2.0) 

## 2D with custom P and species
using Plasma

Tα = 70000 # eV

α = Species(1.602176634e-19, 6.6446562e-27)

function HotCarrier(T) 
    Kb = 8.617333262145e-5
    P(x,v) = exp(-v/(Kb*T))
end

Dα = Distribution(HotCarrier(Tα), α)
G = Geometry() # TODO define a custom geometry

plasma = ElectrostaticPlasma([Dα], G)

Plasma.solve(plasma, dim=2) # with GPU

Plasma.plot(sol)


## 3D CollisionlessPlasma
using Plasma

TD = 15000 # eV
TT = 15000 # eV
Te = 13000 # eV

e = species.e
T = species.T
D = species.D

De = Distribution(Maxwellian(Te, e.m), e)
DT = Distribution(Maxwellian(TT, T.m), T)
DD = Distribution(Maxwellian(TD, D.m), D)
G = Geometry()

plasma = CollisionlessPlasma([De,DT,DD], G)

Plasma.solve(plasma)

Plasma.plot(sol)
